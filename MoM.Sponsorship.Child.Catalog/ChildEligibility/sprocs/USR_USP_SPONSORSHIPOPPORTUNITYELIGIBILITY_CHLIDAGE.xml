<SQLStoredProcedureSpec
	xmlns="bb_appfx_sqlstoredprocedure"
	xmlns:common="bb_appfx_commontypes" 
	ID="a50ffc1e-fa1e-4a34-b50c-ed6ff04f6333"
	Name="USR_USP_SPONSORSHIPOPPORTUNITYELIGIBILITY_CHILDAGE"
	Description="Used to add/delete 'Child is 16 years or older' pending reasons."
	Author="Cary Mayeda"
	SPName="USR_USP_SPONSORSHIPOPPORTUNITYELIGIBILITY_CHILDAGE"	>

	<!-- 
	Remarks:	The 'Child is 16 years or older' pending reason is added if the child/children are over 16.5 years, which @MaxValidAge is set to (in months)
				Also, the child needs to not be sponsored.
				
				This uses UFN_DATE_EARLIESTFROMFUZZYDATE to convert the birthdate (estimate or actual) to a datetime.  
				It uses the first day of the month if not specified and January if the month is not specified.
	
				This is called from USR_USP_SPONSORSHIPOPPORTUNITYELIGIBILITYCHECK, which is used by both the Sponsorship Opportunity Eligibility Check record operation 	
				and with the Sponsorship Opportunity Eligibility Business Process.  As such it needs to be able to handle a single Sponsorship Opportunity Child and
				a Sponsorship Opportunity selection.  
				
	History:
	Date			Modified By		Comments
    27-Mar-2012		CMayeda			Initial Version
	29-Jul-2012		CMayeda			Changed this to take a table instead of the ID or @IDSETREGISTERID
	-->

	<CreateProcedureSQL>
		<![CDATA[
		
create procedure dbo.USR_USP_SPONSORSHIPOPPORTUNITYELIGIBILITY_CHILDAGE (
	@childIDList dbo.USR_UDT_CHILDIDLIST readonly,	-- The children to be made eligible or pending
	@changeAgentID uniqueidentifier,				-- Used to specify change agent for CHANGEDBYID and ADDEDBYID fields
	@deletedRows int = 0 output,					-- Output parm that specifies how many pending reasons were deleted
	@insertedRows int = 0 output)					-- Output parm that specifies how many pending reasons were inserted
	
as
begin

	-- Maximum age of the child in months (16.5 years)
	declare @MaxValidAge int
	set @MaxValidAge = 198

	-- Get ChangeAgent if none was passed into the sproc
  	if @changeAgentID is null  
	    exec dbo.USP_CHANGEAGENT_GETORCREATECHANGEAGENT @changeAgentID output

    -- Used for setting date fields to today's date
	declare @CurrentDate datetime = null  
	set @CurrentDate = getdate()	
	
		
	begin try
	    -- These are required for the sproc to work correctly, so we need to throw an exception if the IDs aren't found
		
    	declare @ChildAgeID uniqueidentifier
		select @ChildAgeID = ID from dbo.SPONSORSHIPREASON where UPPER (REASON) = 'CHILD IS 16 YEARS OR OLDER'
		if @ChildAgeID is null
			RAISERROR 1000000 'Couldn''t find the "Child is 16 years or older" Sponsorship Reason'		

	end try
	begin catch
	    exec dbo.USP_RAISE_ERROR
		return 1	
	end catch
	
	-- This needs to be set to off for the output parms to be set properly
	SET NOCOUNT OFF
	
	-- Remove 'Child is 16 yrs old or Older' pending reasons if the child shouldn't have it (not in group whose Age is over 16.5 and not sponsored)
	delete	dbo.SPONSORSHIPOPPORTUNITYREASON 
	  from	dbo.SPONSORSHIPOPPORTUNITYREASON so_reason
	 where	-- Find children who are specified to be reviewed and have the 'Child is 16 years or older' pending reason 
			exists (select SPONSORSHIPOPPORTUNITYCHILDID from @childIDList where SPONSORSHIPOPPORTUNITYCHILDID = so_reason.SPONSORSHIPOPPORTUNITYID )
	   and	so_reason.SPONSORSHIPREASONID = @ChildAgeID	   
	   
			-- Find children that shouldn't have the reason because they aren't too old and unsponsored
	   and	not exists  (select	ID 
						   from	dbo.SPONSORSHIPOPPORTUNITYCHILD so_child  			 		           
					      where so_child.ID = so_reason.SPONSORSHIPOPPORTUNITYID
						   and dateadd (mm, @MaxValidAge, dbo.UFN_DATE_EARLIESTFROMFUZZYDATE(so_child.BIRTHDATE)) <= getdate() 
					       and dbo.UFN_SPONSORSHIPOPPORTUNITY_ACTIVESPONSORSHIPS(so_child.ID) = 0)
									         				
	set @deletedRows = @@ROWCOUNT
	
	-- Insert 'Child is 16 years or older' pending reason if the child/children are over 16.5 years old and not sponsored
	insert dbo.SPONSORSHIPOPPORTUNITYREASON
				(SPONSORSHIPOPPORTUNITYID,
				 SPONSORSHIPREASONID,				
				 ADDEDBYID, 
				 CHANGEDBYID, 
				 DATEADDED, 
				 DATECHANGED)
				 
		select  ID,
				@ChildAgeID, 
				@changeAgentID, 
				@changeAgentID, 
				@CurrentDate, 
				@CurrentDate
				
	      from	dbo.SPONSORSHIPOPPORTUNITYCHILD	so_child 
						
         where	exists (select SPONSORSHIPOPPORTUNITYCHILDID from @childIDList where SPONSORSHIPOPPORTUNITYCHILDID = so_child.ID )

				-- Verify that the child/children do not already have a 'Child is 16 yrs old or Older' pending reason
   	        and not exists (select SPONSORSHIPOPPORTUNITYID from dbo.SPONSORSHIPOPPORTUNITYREASON so_reason
			                 where so_reason.SPONSORSHIPREASONID = @ChildAgeID and so_reason.SPONSORSHIPOPPORTUNITYID = so_child.ID)

				-- Check Age and verify that child is not sponsored
		    and dateadd (mm, @MaxValidAge, dbo.UFN_DATE_EARLIESTFROMFUZZYDATE(so_child.BIRTHDATE)) <= getdate()
			and dbo.UFN_SPONSORSHIPOPPORTUNITY_ACTIVESPONSORSHIPS(ID) = 0
		
	set @insertedRows = @@ROWCOUNT
	

end


		]]>
	</CreateProcedureSQL>

</SQLStoredProcedureSpec>
