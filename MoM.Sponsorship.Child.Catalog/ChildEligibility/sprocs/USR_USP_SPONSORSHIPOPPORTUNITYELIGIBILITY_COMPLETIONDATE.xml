<SQLStoredProcedureSpec
	xmlns="bb_appfx_sqlstoredprocedure"
	xmlns:common="bb_appfx_commontypes" 
	ID="c28048f9-953e-4456-809c-b02179f90505"
	Name="USR_USP_SPONSORSHIPOPPORTUNITYELIGIBILITY_COMPLETIONDATE"
	Description="Used to add/delete 'Child is 16 yrs old or Older' pending reasons."
	Author="Cary Mayeda"
	SPName="USR_USP_SPONSORSHIPOPPORTUNITYELIGIBILITY_COMPLETIONDATE"
	>

	<!-- 
	Remarks:	The 'Completing Program in 12 Months' pending reason is added if the child/children are within 12 months (@CompletionDateThreshold) of their Current Completion Date
				Also, the child needs to not be sponsored.
	
				This is called from USR_USP_SPONSORSHIPOPPORTUNITYELIGIBILITYCHECK, which is used by both the Sponsorship Opportunity Eligibility Check record operation 	
				and with the Sponsorship Opportunity Eligibility Business Process.  As such it needs to be able to handle a single Sponsorship Opportunity Child and
				a Sponsorship Opportunity selection.  
				
				This is accomplished with the @ID and @IDSETREGISTERID parameters.
				If @ID is not null, then the sproc uses @ID to specify the Sponsorship Opportunity ID
				If @ID is null, then the sproc uses @IDSETREGISTERID to specify the collection of children to check.
				
	History:
	Date			Modified By		Comments
    27-Mar-2012		CMayeda			Initial Version
	-->

	<CreateProcedureSQL>
		<![CDATA[
		
create procedure dbo.USR_USP_SPONSORSHIPOPPORTUNITYELIGIBILITY_COMPLETIONDATE (
	
	
	@ID uniqueidentifier,				-- Specify a Sponsorship Opportunity ID (same as the child's ID) if the sproc should only process a single child
	@IDSETREGISTERID uniqueidentifier,  -- Specify a Selection Set ID if the sproc should process all the children in a query selection
	@CHANGEAGENTID uniqueidentifier,    -- Used to specify change agent for CHANGEDBYID and ADDEDBYID fields
	@DELETEDROWS int = 0 output,        -- Output parm that specifies how many pending reasons were deleted
	@INSERTEDROWS int = 0 output)       -- Output parm that specifies how many pending reasons were inserted
	
as
begin

	-- Number of months from Completion Date in months that children will get pending reason assigned.
	declare @CompletionDateThreshold int
	set @CompletionDateThreshold = 12

	-- Get ChangeAgent if none was passed into the sproc
  	if @CHANGEAGENTID is null  
	    exec dbo.USP_CHANGEAGENT_GETORCREATECHANGEAGENT @CHANGEAGENTID output

    -- Used for setting date fields to today's date
	declare @CurrentDate datetime = null  
	set @CurrentDate = getdate()	
		
	begin try
	    -- These are required for the sproc to work correctly, so we need to throw an exception if the IDs aren't found
		
    	declare @ProgramCompletionID uniqueidentifier
		select @ProgramCompletionID = ID from SPONSORSHIPREASON where UPPER (REASON) = 'COMPLETING PROGRAM IN 12 MONTHS'
		if @ProgramCompletionID is null
			RAISERROR 1000000 'Couldn''t find the "Completing Program in 12 Months" Sponsorship Reason'		
			
		-- Either @ID or @IDSETREGISTERID must be specified.
		if @ID is null and @IDSETREGISTERID is null
			RAISERROR 1000000 '@ID or @IDSETREGISTERID needs to be non-null'		
		
	end try
	begin catch
	    exec dbo.USP_RAISE_ERROR
		return 1	
	end catch
	
	-- This needs to be set to off for the output parms to be set properly
	SET NOCOUNT OFF
	
	-- Remove 'Completing Program in 12 Months' pending reasons if the child shouldn't have it (more than 12 months from Current Completion Date or sponsored)
	delete SPONSORSHIPOPPORTUNITYREASON 
	  from SPONSORSHIPOPPORTUNITYREASON so_reason
	 where 
		-- Find children who are specified to be reviewed and have the 'Completing Program in 12 Months' pending reason 

		-- If a Sponsorship Opportunity ID as passed in @ID, then only process for that child.
	    -- If a single ID was not passed in @ID, then use all the children in the selection passed in @IDSETREGISTERID
		   ((@ID is not null and so_reason.SPONSORSHIPOPPORTUNITYID  = @ID)
			or (@ID is null and exists (Select ID from UFN_IDSETREADER_GETRESULTS (@IDSETREGISTERID) where ID = so_reason.SPONSORSHIPOPPORTUNITYID )))	   

		and so_reason.SPONSORSHIPREASONID = @ProgramCompletionID	   
	   
	   -- Find children that shouldn't have the pending reason anymore because they aren't within 12 months of the Current Completion Date and unsponsored
	   and not exists (select so_child.ID from SPONSORSHIPOPPORTUNITYCHILD so_child  
	                    inner join dbo.USR_CHILDEXTENSION childext on 
							so_child.ID = childext.SPONSORSHIPOPPORTUNITYCHILDID
				        where ((@ID is not null and so_child.ID = @ID)
					  	       or (@ID is null and exists (Select ID from UFN_IDSETREADER_GETRESULTS (@IDSETREGISTERID) where ID = so_child.ID and ID = so_reason.SPONSORSHIPOPPORTUNITYID)))
					      and dateadd (mm, (@CompletionDateThreshold * -1), childext.CURRENTPROGRAMCOMPLETIONDATE) <= getdate() 
					      and dbo.UFN_SPONSORSHIPOPPORTUNITY_ACTIVESPONSORSHIPS(so_child.ID) = 0)
									         				
	set @DELETEDROWS = @@ROWCOUNT
	
	-- Insert 'Completing Program in 12 Months' pending reason if the child/children are less than or equal to 12 months from Current Completion Date and not sponsored
	insert dbo.SPONSORSHIPOPPORTUNITYREASON
				(SPONSORSHIPOPPORTUNITYID,
				 SPONSORSHIPREASONID,				
				 ADDEDBYID, 
				 CHANGEDBYID, 
				 DATEADDED, 
				 DATECHANGED)
				 
		select  so_child.ID,
				@ProgramCompletionID, 
				@CHANGEAGENTID, 
				@CHANGEAGENTID, 
				@CurrentDate, 
				@CurrentDate
				
	       from SPONSORSHIPOPPORTUNITYCHILD	so_child 
     inner join dbo.USR_CHILDEXTENSION childext on 
					so_child.ID = childext.SPONSORSHIPOPPORTUNITYCHILDID
				       
				-- Either get the child passed in @ID or the children in the selection passed in @IDSETREGISTERID
          where ((@ID is not null and so_child.ID = @ID)
			     or (@ID is null and exists (Select ID from UFN_IDSETREADER_GETRESULTS (@IDSETREGISTERID) where ID = so_child.ID )))

				-- Verify that the child/children do not already have a 'Completing Program in 12 Months' pending reason
   	        and not exists (select SPONSORSHIPOPPORTUNITYID from SPONSORSHIPOPPORTUNITYREASON so_reason
			                 where so_reason.SPONSORSHIPREASONID = @ProgramCompletionID and so_reason.SPONSORSHIPOPPORTUNITYID = so_child.ID)

				-- Check Completion Date and verify that child is not sponsored
			and dateadd (mm, (@CompletionDateThreshold * -1), childext.CURRENTPROGRAMCOMPLETIONDATE) <= getdate() 
			and dbo.UFN_SPONSORSHIPOPPORTUNITY_ACTIVESPONSORSHIPS(so_child.ID) = 0
		
	set @INSERTEDROWS = @@ROWCOUNT
	

end

		]]>
	</CreateProcedureSQL>

</SQLStoredProcedureSpec>
