<SQLStoredProcedureSpec
	xmlns="bb_appfx_sqlstoredprocedure"
	xmlns:common="bb_appfx_commontypes" 
	ID="4f2f1a96-ab58-47fd-95ec-54752f26a21e"
	Name="USR_USP_CHILDQUOTA_PROCESS_CHILDLIST"
	Description="This is used to in the business process to check the children passed in @childList"
	Author="Cary Mayeda"
	SPName="USR_USP_CHILDQUOTA_PROCESS_CHILDLIST"
	>

	<!-- 
	Remarks:    

	History:
	Date            Modified By     Comments
	02-Jul-2012		CMayeda			Initial Version
	-->

	<CreateProcedureSQL>
		<![CDATA[
create procedure dbo.USR_USP_CHILDQUOTA_PROCESS_CHILDLIST (
	@childList USR_UDT_QUOTAPROCESSCHILDREN readonly,	-- Used to specify the children to process
	@changeAgentID uniqueidentifier,					-- Used to specify change agent for ChangedByID and AddedByID fields
	@successTableName nvarchar(128) = '',					-- Table Name to insert children successfuly registered, pass empty string if no table needs to be populated
	@exceptionTableName nvarchar(128) = '',					-- Table Name to insert exceptions, pass empty string if no table needs to be populated
	@successCount int = 0 output,						-- Number of children successfully registered
	@exceptionCount int = 0 output						-- Number of exceptions - this isn't always the number children, because only one row is entered for a lock failure
)

as
begin
	-- Get ChangeAgent if none was passed into the sproc
  	if @changeAgentID is null  
	    exec dbo.USP_CHANGEAGENT_GETORCREATECHANGEAGENT @changeAgentID output

	declare @changeAgentUserName nvarchar(128)
	select @changeAgentUserName = USERNAME from dbo.CHANGEAGENT where ID = @changeAgentID

	
	declare @currentDateTime datetime							-- Used to store the current Date / Time
	set @currentDateTime  = getdate()

	declare @quotaType_Project as tinyint = 0					-- Code value for Project Quota 
	declare @quotaType_Country as tinyint = 1					-- Code value for Country Quota 

	-- ** Had to use temp tables instead of just referencing the table vars because of permission issues when called from the business process
	-- ** The EXECUTE permission was denied on the object 'USR_UDT_CHILDIDLIST'

	-- Used to insert children successfully registered into the Success Table for project quotas
	declare @insertSuccessSQL nvarchar(max) = ''
	if @successTableName <> ''
		set @insertSuccessSQL  = 'insert ' + @successTableName + ' select @projectID, @countryID, SPONSORSHIPOPPORTUNITYCHILDID from #registeredChildren' -- @childList'
	declare @insertSuccessSQLParms nvarchar(255) = '@projectID uniqueidentifier, @countryID uniqueidentifier'--, @childList dbo.USR_UDT_CHILDIDLIST readonly'

	-- Used to insert exceptions into the Exception Table
	declare @insertExceptionsSQL nvarchar(max) = ''
	if @exceptionTableName <> '' 
		set	@insertExceptionsSQL = 'insert ' + @exceptionTableName + ' select @projectID, @countryID, SPONSORSHIPOPPORTUNITYCHILDID, SPONSORSHIPREASONID from #ineligibleChildren'--@childList'
	declare @insertExceptionsSQLParm nvarchar(255) = '@projectID uniqueidentifier, @countryID uniqueidentifier'--, @childList dbo.USR_UDT_CHILDIDLISTWITHREASON readonly'
		
	-- Used to get the count of successfully registered children
	declare @countSuccessSQL nvarchar(max) = 'select @successCount=count(*) from ' + @successTableName 
	declare @countSuccessSQLParms nvarchar(255) = '@successCount int output'
	
	-- Used to get the count of exceptions
	declare @countExceptionSQL nvarchar(max) = 'select @exceptionCount=count(*) from ' + @exceptionTableName 
	declare @countExceptionSQLParms nvarchar(255) = '@exceptionCount int output'
	
	-- Used to insert a single exception into the Exception Table
	declare @insertSingleExceptionSQL nvarchar(max) = 'insert ' + @exceptionTableName + ' select @projectID, @countryID, @childID, @exceptionReason'
		
	declare @insertSingleExceptionSQLParm nvarchar(255) = '@projectID uniqueidentifier, @countryID uniqueidentifier, @childID uniqueidentifier, @exceptionReason nvarchar(255)'	

	declare @lockMaxAttempts tinyint = 5						-- How many times to retry attempting acquiring a lock
	declare @lockDelayString char(8) = '00:00:02'				-- How long to wait in between lock attempts.  Delay uses a string formatted as time - hh:mm:ss
	

	declare @childProjectID uniqueidentifier					-- Used to store the child project being processed 
	declare @countryID uniqueidentifier							-- Used to store the country being processed if it is country quota
	
	declare @quotaType tinyint
	
 	declare @lockFailed table (quotaType tinyint,  -- 0 = project, 1 = country
							   objectID uniqueidentifier)

	declare @lockObjectID uniqueidentifier
	declare @objectLocked bit
	
	-- Cursor of projects included in the child list
	declare childListCursor cursor for
	select distinct childProjectID from @childList

	open childListCursor 
	fetch next from childListCursor 
		into @childProjectID
		
	-- Process each project on the child list
	while @@FETCH_STATUS = 0
	begin

		set @quotaType = dbo.USR_UFN_CHILDPROJECT_QUOTATYPE (@childProjectID)
		
		-- Try to lock the current child project
		if @quotaType = @quotaType_Project
			set @lockObjectID = @childProjectID
		else
		begin
			set @countryID = dbo.USR_UFN_CHILDPROJECT_GETCOUNTRYID (@childProjectID)
			-- ******** CHECK FOR NULL
			set @lockObjectID = @countryID
		end
		
		set @objectLocked = 0
		declare @lockAttempts int = 0
		while @lockAttempts < @lockMaxAttempts and @objectLocked = 0 
		begin
			set @lockAttempts = @lockAttempts + 1
			set @objectLocked = 1
			begin try
				exec dbo.USR_USP_BATCHLOCKINSERT @lockObjectID, @currentDateTime, @changeAgentUserName
			end try
			begin catch
				set @objectLocked = 0
				if @lockAttempts < @lockMaxAttempts
					waitfor delay @lockDelayString
			end catch	
		end 
	
		if @objectLocked = 0
		begin
			-- Child Project could not be locked, so we need to log this in the output parm @lockFailed and the business process exception table
			if @quotaType = @quotaType_Project
			begin
				insert @lockFailed
				select @quotaType_Project, @childProjectID 
			
				if @exceptionTableName <> ''	-- If an exception table was specific, insert a row for the lock failure
					exec sp_executesql @insertSingleExceptionSQL, @insertSingleExceptionSQLParm, @projectID=@childProjectID,@countryID=NULL,@childID=NULL, @exceptionReason='Child Project could not be locked'
			end
			else
			begin
				insert @lockFailed
				select @quotaType_Country, @countryID  
				
				if @exceptionTableName <> ''	-- If an exception table was specific, insert a row for the lock failure
					exec sp_executesql @insertSingleExceptionSQL, @insertSingleExceptionSQLParm, @projectID=@childProjectID,@countryID=@countryID,@childID=NULL, @exceptionReason='Country could not be locked' 
			end
		end 
		else
		begin
			if @quotaType = @quotaType_Project
				exec dbo.USR_USP_CHILDQUOTA_PROCESS_PROJECT @childProjectID, @childList, @changeAgentID, @insertSuccessSQL, @insertSuccessSQLParms, @insertExceptionsSQL, @insertExceptionsSQLParm

			else
				exec dbo.USR_USP_CHILDQUOTA_PROCESS_PROJECT_WITHCOUNTRYQUOTA @childProjectID, @countryID, @childList, @changeAgentID, @insertSuccessSQL, @insertSuccessSQLParms, @insertExceptionsSQL, @insertExceptionsSQLParm  

			-- Unlock project / country
			exec dbo.USR_USP_DELETEBATCHLOCK @lockObjectID, @changeAgentUserName
			
		end
		
		fetch next from childListCursor 
		into @childProjectID

	end
	

	close childListCursor
	deallocate childListCursor


	if @successTableName <> ''
		exec sp_executesql @countSuccessSQL, @countSuccessSQLParms, @successCount=@successCount output
	
	if @exceptionTableName <> ''
		exec sp_executesql @countExceptionSQL, @countExceptionSQLParms, @exceptionCount=@exceptionCount output

	select quotaType, objectID from @lockFailed 					   

	return 0

end

		]]>
	</CreateProcedureSQL>
	
</SQLStoredProcedureSpec>
